<!doctype html>
<html lang="fa">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ثبت‌نام</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<header class="topbar">
  <h1>تکمیل پروفایل</h1>
</header>

<main class="register-card">
  <img id="avatar" class="avatar"
       src="https://via.placeholder.com/110">

  <input id="displayName" placeholder="نام نمایشی">
  <input id="username" placeholder="نام کاربری (انگلیسی)">
  <textarea id="bio" placeholder="بیو (اختیاری)"></textarea>

  <button onclick="submitRegister()">ثبت و ادامه</button>
  <p id="msg" class="center-msg"></p>
</main>

<script src="https://tapi.bale.ai/miniapp.js?3"></script>
<script src="auth.js"></script>
<script>
const API_BASE = "https://insta-api-avn2.onrender.com/api";

const authUser = requireAuth();

// پر کردن خودکار
displayName.value = authUser.first_name || "";
username.value = authUser.username || "";

async function submitRegister(){
  const msg = document.getElementById("msg");
  msg.innerText = "در حال ثبت‌نام…";

  try{
    const display_name = displayName.value.trim();
    const usernameVal = username.value.trim().replace("@","");
    const bioVal = bio.value.trim();

    if(!display_name)
      return msg.innerText = "نام نمایشی الزامی است";

    if(!/^[a-zA-Z0-9_.]{3,20}$/.test(usernameVal))
      return msg.innerText = "نام کاربری نامعتبر است";

    const res = await fetch(`${API_BASE}/register`,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        user_id: authUser.id,
        display_name,
        username: usernameVal,
        bio: bioVal
      })
    });

    const data = await res.json();

    if(!res.ok)
      return msg.innerText = data.detail || "خطا در ثبت‌نام";

    location.replace("home.html");

  }catch(e){
    msg.innerText = "خطای غیرمنتظره: " + e.message;
  }
}
</script>

</body>
</html>
