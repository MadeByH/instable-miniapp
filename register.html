<!doctype html>
<html lang="fa">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<header class="topbar">
  <h1>ØªÚ©Ù…ÛŒÙ„ Ù¾Ø±ÙˆÙØ§ÛŒÙ„</h1>
</header>

<main class="card" style="margin:20px;">
  <img id="avatar" class="avatar"
       src="https://via.placeholder.com/110">

  <input id="displayName" placeholder="Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ">
  <input id="username" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ (Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ)">
  <textarea id="bio" placeholder="Ø¨ÛŒÙˆ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)"></textarea>

  <button onclick="submitRegister()">Ø«Ø¨Øª Ùˆ Ø§Ø¯Ø§Ù…Ù‡</button>
  <p id="msg" class="center-msg"></p>
</main>

<script src="https://tapi.bale.ai/miniapp.js?3"></script>
<script src="auth.js"></script>

<script>
const API_BASE = "https://insta-api-avn2.onrender.com/api";

// ğŸŸ¢ Ù¾Ø± Ú©Ø±Ø¯Ù† Ø®ÙˆØ¯Ú©Ø§Ø± Ø§Ø² Ø¨Ù„Ù‡
(async ()=>{
  try{
    await waitForBaleUser();
    const u = Bale.WebApp.initDataUnsafe.user;

    if(u?.first_name)
      displayName.value = u.first_name;

    if(u?.username)
      username.value = u.username;

  }catch{}
})();

async function submitRegister(){
  const msg = document.getElementById("msg");
  msg.innerText = "Ø¯Ø± Ø­Ø§Ù„ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…â€¦";

  try{
    await waitForBaleUser();
    const userId = getUserId();

    const display_name = displayName.value.trim();
    const username = username.value.trim().replace("@","");
    const bio = bio.value.trim();

    if(!display_name)
      return msg.innerText = "Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª";

    if(!/^[a-zA-Z0-9_.]{3,20}$/.test(username))
      return msg.innerText = "Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª";

    const res = await fetch(`${API_BASE}/register`,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        user_id: userId,
        display_name,
        username,
        bio
      })
    });

    const data = await res.json();

    if(!res.ok)
      return msg.innerText = "Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…";

    // âœ… Ù…ÙˆÙÙ‚
    location.replace("home.html");

  }catch(e){
    msg.innerText = "Ø®Ø·Ø§ÛŒ ØºÛŒØ±Ù…Ù†ØªØ¸Ø±Ù‡";
  }
}
</script>

</body>
</html>
