<!doctype html>
<html lang="fa">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Home</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<header class="topbar">
  <h1>Instable</h1>
</header>

<main id="feed"></main>
<div id="loading" class="loading">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾Ø³Øªâ€ŒÙ‡Ø§â€¦</div>

<div id="nav"></div>

<script src="auth.js"></script>
<script>
const API_BASE = "https://insta-api-avn2.onrender.com/api";

let me;
try {
  me = requireAuth();
} catch {
  // Ø±ÛŒØ¯Ø§ÛŒØ±Ú©Øª Ø´Ø¯Ù‡
}

async function loadFeed(){
  const feed = document.getElementById("feed");
  const loading = document.getElementById("loading");

  try {
    const res = await fetch(`${API_BASE}/get_feed/${me.id}`);
    const posts = await res.json();

    loading.style.display = "none";

    if (!Array.isArray(posts) || posts.length === 0) {
      feed.innerHTML = `<p class="center-msg">Ù‡Ù†ÙˆØ² Ù¾Ø³ØªÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</p>`;
      return;
    }

    posts.forEach(p => {
      const div = document.createElement("div");
      div.className = "post";

      const imgUrl = p.photo
        ? `${API_BASE}/media_proxy?file_id=${p.photo}`
        : "https://via.placeholder.com/600";

      div.innerHTML = `
        <div class="post-header">
          <span class="avatar-sm">ğŸ‘¤</span>
          <span class="username">user ${p.user_id}</span>
        </div>

        <img class="post-img" src="${imgUrl}">

        <div class="post-actions">
          â¤ï¸ ${p.likes || 0}
        </div>
      `;

      feed.appendChild(div);
    });

  } catch {
    loading.innerText = "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙÛŒØ¯";
  }
}

loadFeed();
</script>

<script>
fetch("nav.html")
  .then(r => r.text())
  .then(html => document.getElementById("nav").innerHTML = html);
</script>

</body>
</html>
