<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>خانه</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<header class="topbar"><h1>خانه</h1></header>

<main>
  <div id="grid" class="grid"></div>
  <div id="loading" class="loading">در حال بارگذاری…</div>
</main>

<!-- ناوبری -->
<div id="nav"></div>

<script>
  window.API_BASE = "https://insta-api-avn2.onrender.com/api";

  // بارگذاری پست‌ها از API (پست‌های افراد دنبال‌شده)
  async function initHome() {
    const grid = document.getElementById('grid');
    const loading = document.getElementById('loading');
    loading.style.display = 'block';

    try {
      // برای گرفتن پست‌های کاربرهای دنبال‌شده
      const userId = await ensureRegistered();
      const res = await fetch(`${API_BASE}/get_feed/${userId}`);
      const posts = await res.json();

      loading.style.display = 'none';
      if (posts.length === 0) {
        grid.innerHTML = "<p class='center-msg'>هیچ پستی برای نمایش وجود ندارد</p>";
        return;
      }

      posts.forEach(post => {
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
          <img src="${post.photo ? `${API_BASE}/media_proxy?file_id=${post.photo}` : 'https://via.placeholder.com/300x300'}" />
        `;
        div.onclick = () => {
          window.location.href = `post.html?post_id=${post.post_id}`;
        };
        grid.appendChild(div);
      });
    } catch (e) {
      console.error(e);
      loading.style.display = 'none';
      grid.innerHTML = `<p class="center-msg">خطا در بارگذاری پست‌ها</p>`;
    }
  }

  // بارگذاری ناوبری
  fetch("nav.html")
    .then(r => r.text())
    .then(html => document.getElementById("nav").innerHTML = html);

  // زمانی که صفحه بارگذاری می‌شود، پست‌ها را بارگذاری می‌کنیم
  window.onload = initHome;
</script>

<script src="app.js"></script>
<script src="https://tapi.bale.ai/miniapp.js?3"></script>

</body>
</html>
