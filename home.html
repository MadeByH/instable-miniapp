<!doctype html>
<html lang="fa">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ø®Ø§Ù†Ù‡</title>
<link rel="stylesheet" href="style.css">
<link rel="stylesheet"
 href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>

<body>

<!-- ğŸ” Header -->
<header class="topbar insta-header">
  <span class="logo">InstaBale</span>
  <div class="top-icons">
    <span onclick="location.href='upload.html'"><i class="fas fa-plus-square"></i></span>
    <span onclick="location.href='notifications.html'"><i class="far fa-heart"></i></span>
  </div>
</header>

<!-- ğŸ“¸ Stories -->
<div class="stories" id="stories"></div>

<!-- ğŸ“° Feed -->
<main id="feed"></main>
<div id="loading" class="loading">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒâ€¦</div>

<div id="nav"></div>

<script src="https://tapi.bale.ai/miniapp.js?3"></script>
<script src="auth.js"></script>

<script>
const API_BASE = "https://insta-api-avn2.onrender.com/api";
const me = requireAuth();

let page = 0;
let loadingMore = false;

/* =======================
   Stories ÙˆØ§Ù‚Ø¹ÛŒ
======================= */
async function loadStories(){
  const el = document.getElementById("stories");

  // Ø§Ø³ØªÙˆØ±ÛŒ Ø®ÙˆØ¯Ù…
  el.innerHTML = `
    <div class="story you" onclick="location.href='story.html'">
        <div class="story-ring you-ring">
          <img src="${me.profile_pic
            ? API_BASE + '/media_proxy?file_id=' + me.profile_pic
            : 'https://via.placeholder.com/60'}">
        </div>
        Ø´Ù…Ø§
      </div>
  `;

  try{
    const res = await fetch(`${API_BASE}/get_stories/${me.id}`);
    const stories = await res.json();

    stories.forEach(s=>{
      el.innerHTML += `
        <div class="story"
          onclick="location.href='story.html?user_id=${s.user.id}'">

          <div class="story-ring ${s.has_unseen ? 'active' : 'seen'}">
            <img src="${s.user.avatar
              ? API_BASE + '/media_proxy?file_id=' + s.user.avatar
              : 'https://via.placeholder.com/60'}">
          </div>

          ${s.user.username}
        </div>
      `;
    });
  }catch{}
}

/* =======================
   Feed Ø§ÛŒÙ†Ø³ØªØ§ÛŒÛŒ
======================= */
async function loadFeed(){
  const feed = document.getElementById("feed");
  const loading = document.getElementById("loading");

  loading.style.display = "block";

  try{
    const res = await fetch(`${API_BASE}/get_feed/${me.id}?page=${page}`);
    const posts = await res.json();

    posts.forEach((p,i)=>{
      // Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø¯Ù†Ø¨Ø§Ù„â€ŒÚ©Ø±Ø¯Ù† Ø¨Ø¹Ø¯ Ø§Ø² Ú†Ù†Ø¯ Ù¾Ø³Øª
      if(page === 0 && i === 3){
        feed.appendChild(buildSuggestBox());
      }

      const div = document.createElement("div");
      div.className = "post";

      div.innerHTML = `
        <div class="post-header">
          <img class="avatar-sm"
            src="${p.user.avatar
              ? API_BASE + '/media_proxy?file_id=' + p.user.avatar
              : 'https://via.placeholder.com/28'}">
          <span class="username"
            onclick="location.href='profile.html?user_id=${p.user.id}'">
            ${p.user.username}
          </span>
        </div>

        ${
          p.type === "video"
          ? `<video class="post-img" src="${API_BASE}/media_proxy?file_id=${p.video_id}" muted loop autoplay></video>`
          : `<img class="post-img" src="${API_BASE}/media_proxy?file_id=${p.photo}">`
        }

        <div class="post-actions">
          <div class="icons">
            <i class="far fa-heart"></i>
            <i class="far fa-comment"></i>
            <i class="far fa-paper-plane"></i>
          </div>
          <div class="likes">${p.likes} Ù¾Ø³Ù†Ø¯</div>
        </div>
      `;

      feed.appendChild(div);
    });

    if(posts.length === 0 && page === 0){
      feed.innerHTML = `<p class="center-msg">Ù‡Ù†ÙˆØ² Ù¾Ø³ØªÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</p>`;
    }

  }catch{
    if(page === 0)
      feed.innerHTML = `<p class="center-msg">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙÛŒØ¯</p>`;
  }finally{
    loading.style.display="none";
    loadingMore = false;
  }
}

/* =======================
   Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø¯Ù†Ø¨Ø§Ù„â€ŒÚ©Ø±Ø¯Ù†
======================= */
function buildSuggestBox(){
  const box = document.createElement("div");
  box.className = "suggest-box";
  box.innerHTML = `
    <h4>Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§</h4>
    <div class="suggest-list">
      <div class="suggest-item">
        <img src="https://via.placeholder.com/50">
        <span>user_test</span>
        <button>Ø¯Ù†Ø¨Ø§Ù„ Ú©Ø±Ø¯Ù†</button>
      </div>
      <div class="suggest-item">
        <img src="https://via.placeholder.com/50">
        <span>instabale</span>
        <button>Ø¯Ù†Ø¨Ø§Ù„ Ú©Ø±Ø¯Ù†</button>
      </div>
    </div>
  `;
  return box;
}

/* =======================
   Infinite Scroll
======================= */
window.addEventListener("scroll", ()=>{
  if(
    window.innerHeight + window.scrollY >
    document.body.offsetHeight - 300
  ){
    if(!loadingMore){
      loadingMore = true;
      page++;
      loadFeed();
    }
  }
});

/* Init */
loadStories();
loadFeed();
</script>

<script>
fetch("nav.html")
  .then(r=>r.text())
  .then(html=>nav.innerHTML=html);
</script>

</body>
</html>
