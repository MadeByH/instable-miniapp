<!doctype html>
<html lang="fa">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ø®Ø§Ù†Ù‡</title>
<link rel="stylesheet" href="style.css">
</head>

<body>

<!-- ğŸ” Header -->
<header class="topbar insta-header">
  <span class="logo">InstaBale</span>
  <div class="top-icons">
    <span onclick="location.href='upload.html'">â•</span>
    <span onclick="location.href='notifications.html'">â¤ï¸</span>
  </div>
</header>

<!-- ğŸ“¸ Stories -->
<div class="stories" id="stories"></div>

<!-- ğŸ“° Feed -->
<main id="feed"></main>
<div id="loading" class="loading">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒâ€¦</div>

<div id="nav"></div>

<script src="https://tapi.bale.ai/miniapp.js?3"></script>
<script src="auth.js"></script>

<script>
const API_BASE = "https://insta-api-avn2.onrender.com/api";

/* -------------------------
   Stories (ÙØ¹Ù„Ø§Ù‹ ÙÛŒÚ©)
-------------------------- */
const stories = document.getElementById("stories");

stories.innerHTML = `
  <div class="story you">
    <div class="story-ring">
      <img src="https://via.placeholder.com/60">
    </div>
    Ø´Ù…Ø§
  </div>
`;

for(let i=1;i<=8;i++){
  stories.innerHTML += `
    <div class="story">
      <div class="story-ring">
        <img src="https://via.placeholder.com/60">
      </div>
      user${i}
    </div>
  `;
}

/* -------------------------
   Feed
-------------------------- */
async function loadFeed(){
  const feed = document.getElementById("feed");
  const loading = document.getElementById("loading");

  try{
    const me = requireAuth();

    const res = await fetch(`${API_BASE}/get_feed/${me.id}`);
    const posts = await res.json();

    feed.innerHTML = "";

    posts.forEach(p=>{
      const div = document.createElement("div");
      div.className = "post";

      div.innerHTML = `
        <div class="post-header">
          <div class="avatar-sm">ğŸ‘¤</div>
          <span class="username">user_${p.user_id}</span>
        </div>

        <img class="post-img"
          src="${p.photo ? API_BASE + '/media_proxy?file_id=' + p.photo : 'https://via.placeholder.com/400'}">

        <div class="post-actions">
          <div>
            â¤ï¸ ğŸ’¬ ğŸ“¤
          </div>
          <div class="likes">${p.likes || 0} Ù¾Ø³Ù†Ø¯</div>
        </div>
      `;

      feed.appendChild(div);
    });

  }catch(e){
    feed.innerHTML = `<p class="center-msg">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙÛŒØ¯</p>`;
  }finally{
    loading.style.display="none";
  }
}

loadFeed();
</script>

<script>
fetch("nav.html")
  .then(r=>r.text())
  .then(html=>nav.innerHTML=html);
</script>

</body>
</html>
