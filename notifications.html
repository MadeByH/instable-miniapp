<script>
const logBox = document.getElementById("debug");
function log(msg) {
  const d = document.createElement("div");
  d.textContent = msg;
  logBox.appendChild(d);
}

(async () => {
  log("STEP 1: شروع انتظار برای کاربر بله...");

  try {
    await waitForBaleUser();
    log("✅ initDataUnsafe آماده شد");

    const uid = getUserId();
    log("✅ userId = " + uid);

    const res = await fetch(`${API_BASE}/notifications/${uid}`);
    log("HTTP Status = " + res.status);

    const data = await res.json();
    log("API Response = " + JSON.stringify(data));

    document.getElementById("loading").style.display = "none";

    if (!data.length) {
      document.getElementById("notifRoot").innerHTML =
        "<p>اعلانی وجود ندارد</p>";
      return;
    }

    data.forEach(n => {
      const div = document.createElement("div");
      div.className = "notif" + (n.is_read ? "" : " unread");
      div.innerHTML = `
        <div>${n.text}</div>
        <div class="notif-time">${n.created_at}</div>
      `;
      document.getElementById("notifRoot").appendChild(div);
    });

  } catch (e) {
    log("❌ ERROR: " + e.message);
    document.getElementById("loading").textContent =
      "خطا در دریافت اعلان‌ها";
  }
})();
</script>
