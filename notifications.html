<!doctype html>
<html lang="fa">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>اعلان‌ها</title>
<link rel="stylesheet" href="style.css">

<style>
.notif{
  padding:14px;
  border-bottom:1px solid rgba(255,255,255,.06);
}
.notif-time{
  font-size:12px;
  color:#8aa0b8;
  margin-top:4px;
}
.center-msg{
  text-align:center;
  color:#9eb0c8;
  margin-top:30px;
}
</style>
</head>

<body>

<header class="topbar">
  <h1>اعلان‌ها</h1>
</header>

<main id="notifRoot"></main>
<div id="loading" class="loading">در حال بارگذاری…</div>
<div id="nav"></div>

<!-- ============================= -->
<!-- تنظیمات -->
<!-- ============================= -->
<script>
window.API_BASE = "https://insta-api-avn2.onrender.com/api";
</script>

<!-- ============================= -->
<!-- Bale Loader -->
<!-- ============================= -->
<script src="https://tapi.bale.ai/miniapp.js?3"></script>

<!-- ============================= -->
<!-- Helpers -->
<!-- ============================= -->
<script>
async function waitForBaleUser(timeout = 6000) {
  const start = Date.now();

  while (Date.now() - start < timeout) {
    if (
      window.Bale &&
      window.Bale.WebApp &&
      window.Bale.WebApp.initDataUnsafe &&
      (
        window.Bale.WebApp.initDataUnsafe.user?.id ||
        window.Bale.WebApp.initDataUnsafe.user_id ||
        window.Bale.WebApp.initDataUnsafe.receiver?.id
      )
    ) {
      return true;
    }
    await new Promise(r => setTimeout(r, 100));
  }

  throw new Error("USER_NOT_READY");
}

function getUserId() {
  const data = window.Bale.WebApp.initDataUnsafe;

  return (
    data.user?.id ||
    data.user_id ||
    data.receiver?.id ||
    null
  );
}

function safeStart(fn) {
  let started = false;
  function start() {
    if (started) return;
    started = true;
    fn();
  }

  setTimeout(start, 200);
  setTimeout(start, 800);
  setTimeout(start, 1500);
}
</script>

<script src="auth.js"></script>

<!-- ============================= -->
<!-- Main Logic -->
<!-- ============================= -->
<script>
async function loadNotifications() {
  const root = document.getElementById("notifRoot");
  const loading = document.getElementById("loading");

  try {
    const userId = await ensureRegistered();
    // 4️⃣ گرفتن اعلان‌ها
    const res = await fetch(`${API_BASE}/notifications/${userId}`);
    if (!res.ok) throw new Error("API_ERROR");

    const data = await res.json();
    loading.style.display = "none";

    // 5️⃣ اعلان ندارد
    if (!Array.isArray(data) || data.length === 0) {
      root.innerHTML = `<p class="center-msg">اعلانی وجود ندارد</p>`;
      return;
    }

    // 6️⃣ نمایش اعلان‌ها
    data.forEach(n => {
      const div = document.createElement("div");
      div.className = "notif";
      div.innerHTML = `
        <div>${n.text}</div>
        <div class="notif-time">${n.created_at}</div>
      `;
      root.appendChild(div);
    });

  } catch (e) {
    loading.style.display = "none";

    if (e.message === "NOT_IN_BALE") {
      root.innerHTML = `<p class="center-msg">این صفحه فقط داخل بله قابل استفاده است</p>`;
    } 
    else if (e.message === "REDIRECT_REGISTER") {
  return;
  }
    else {
      root.innerHTML = `<p class="center-msg">خطا در دریافت اعلان‌ها</p>`;
    }

    console.error("Notifications error:", e.message);
  }
}
</script>

<!-- ============================= -->
<!-- Run -->
<!-- ============================= -->
<script>
safeStart(loadNotifications);
</script>

<!-- ============================= -->
<!-- Navigation -->
<!-- ============================= -->
<script>
fetch("nav.html")
  .then(r => r.text())
  .then(html => document.getElementById("nav").innerHTML = html);
</script>

</body>
</html>
