<script src="https://tapi.bale.ai/miniapp.js?3"></script>
<script src="app.js"></script>

<script>
window.API_BASE = "https://insta-api-avn2.onrender.com/api";

const root = document.getElementById("notifRoot");
const loading = document.getElementById("loading");

function log(msg) {
  const d = document.createElement("div");
  d.textContent = msg;
  d.style.fontSize = "12px";
  d.style.opacity = "0.8";
  root.appendChild(d);
}

(async () => {
  log("ğŸ”¹ Ø´Ø±ÙˆØ¹ MiniApp");

  try {
    log("â³ waitForBaleUser()");
    await waitForBaleUser();

    const uid = getUserId();
    log("ğŸ‘¤ userId = " + uid);

    const res = await fetch(`${API_BASE}/notifications/${uid}`);
    log("ğŸ“¡ HTTP = " + res.status);

    let data;
    try {
      data = await res.json();
    } catch {
      throw new Error("INVALID_JSON_FROM_API");
    }

    log("ğŸ“¦ data = " + JSON.stringify(data));
    loading.style.display = "none";

    if (!Array.isArray(data) || data.length === 0) {
      root.innerHTML += "<p>Ø§Ø¹Ù„Ø§Ù†ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</p>";
      return;
    }

    data.forEach(n => {
      const div = document.createElement("div");
      div.className = "notif" + (n.is_read ? "" : " unread");
      div.innerHTML = `
        <div>${n.text}</div>
        <div class="notif-time">${n.created_at}</div>
      `;
      root.appendChild(div);
    });

  } catch (e) {
    loading.style.display = "none";
    root.innerHTML += `<p style="color:red">âŒ ${e.message}</p>`;
  }
})();
    </script>
