<script src="https://tapi.bale.ai/miniapp.js?3"></script>
<script src="auth.js"></script>

<script>
async function loadNotifications() {
  const root = document.getElementById("notifRoot");
  const loading = document.getElementById("loading");

  loading.style.display = "block";

  const auth = await ensureRegistered();

  if (!auth.ok) {
    loading.style.display = "none";

    if (auth.reason === "NOT_REGISTERED") {
      location.replace("register.html");
      return;
    }

    root.innerHTML = `<p class="center-msg">عدم دسترسی</p>`;
    return;
  }

  const res = await fetch(`${API_BASE}/notifications/${auth.userId}`);
  loading.style.display = "none";

  if (!res.ok) {
    root.innerHTML = `<p class="center-msg">خطا در دریافت اعلان‌ها</p>`;
    return;
  }

  const data = await res.json();

  if (!data.length) {
    root.innerHTML = `<p class="center-msg">اعلانی وجود ندارد</p>`;
    return;
  }

  data.forEach(n => {
    const div = document.createElement("div");
    div.className = "notif";
    div.innerHTML = `
      <div>${n.text}</div>
      <div class="notif-time">${n.created_at}</div>
    `;
    root.appendChild(div);
  });
}

Bale.WebApp.ready();
loadNotifications();
    </script>
