<!doctype html>
<html lang="fa">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>اعلان‌ها (Debug)</title>
<link rel="stylesheet" href="style.css">

<style>
  .log {
    font-family: monospace;
    font-size: 12px;
    background: #111;
    color: #0f0;
    padding: 10px;
    margin: 10px;
    border-radius: 8px;
    white-space: pre-wrap;
    direction: ltr;
  }
  .error { color: #ff6b6b; }
  .ok { color: #4cd137; }
</style>
</head>

<body>

<header class="topbar">
  <h1>اعلان‌ها (Debug)</h1>
</header>

<div id="debug" class="log">شروع لاگ…</div>

<main id="notifRoot"></main>
<div id="loading" class="loading">در حال بارگذاری…</div>

<script src="https://tapi.bale.ai/miniapp.js?3"></script>
<script src="app.js"></script>

<script>
window.API_BASE = "https://insta-api-avn2.onrender.com/api";

const logBox = document.getElementById("debug");
const loading = document.getElementById("loading");
const root = document.getElementById("notifRoot");

function log(msg, cls="") {
  const span = document.createElement("div");
  span.textContent = msg;
  if (cls) span.className = cls;
  logBox.appendChild(span);
}

// ===============================
// STEP 1: Check Bale
// ===============================
log("STEP 1: بررسی window.Bale ...");

if (!window.Bale) {
  log("❌ window.Bale وجود ندارد", "error");
  loading.textContent = "Bale WebApp در دسترس نیست";
  throw new Error("NO_BALE");
}

log("✅ window.Bale موجود است", "ok");

// ===============================
// STEP 2: Check WebApp
// ===============================
if (!window.Bale.WebApp) {
  log("❌ Bale.WebApp وجود ندارد", "error");
  loading.textContent = "WebApp لود نشده";
  throw new Error("NO_WEBAPP");
}

log("✅ Bale.WebApp موجود است", "ok");

// ===============================
// STEP 3: ready()
// ===============================
log("STEP 2: فراخوانی Bale.WebApp.ready()");

Bale.WebApp.ready(() => {
  log("✅ WebApp.ready اجرا شد", "ok");

  // ===============================
  // STEP 4: initDataUnsafe
  // ===============================
  log("STEP 3: بررسی initDataUnsafe");

  const data = Bale.WebApp.initDataUnsafe;
  log("initDataUnsafe = " + JSON.stringify(data, null, 2));

  if (!data) {
    log("❌ initDataUnsafe خالی است", "error");
    loading.textContent = "initDataUnsafe وجود ندارد";
    return;
  }

  const uid =
    data.user?.id ||
    data.user_id ||
    data.receiver?.id;

  log("STEP 4: استخراج userId");

  if (!uid) {
    log("❌ userId پیدا نشد", "error");
    loading.textContent = "userId نامعتبر";
    return;
  }

  log("✅ userId = " + uid, "ok");

  // ===============================
  // STEP 5: API Request
  // ===============================
  log("STEP 5: ارسال درخواست نوتیفیکیشن");

  fetch(`${API_BASE}/notifications/${uid}`)
    .then(res => {
      log("HTTP Status = " + res.status);
      return res.json();
    })
    .then(data => {
      loading.style.display = "none";
      log("API Response = " + JSON.stringify(data, null, 2));

      if (!Array.isArray(data) || !data.length) {
        root.innerHTML = "<p>اعلانی وجود ندارد</p>";
        return;
      }

      data.forEach(n => {
        const div = document.createElement("div");
        div.className = "notif";
        div.innerHTML = `
          <div>${n.text}</div>
          <div style="font-size:12px;opacity:.7">${n.created_at}</div>
        `;
        root.appendChild(div);
      });
    })
    .catch(err => {
      log("❌ خطا در fetch: " + err.message, "error");
      loading.textContent = "خطا در دریافت اعلان‌ها";
    });
});
</script>

</body>
</html>
