  <script>
    const API_BASE = "https://insta-api-avn2.onrender.com/api"; 

    async function loadNotifications() {
      const root = document.getElementById("notifRoot");
      const loading = document.getElementById("loading");
      loading.style.display = "block"; // مطمئن می‌شویم لودینگ نمایش داده شود

      try {
        // 1. تغییر اصلی: ensureRegistered اکنون مستقیماً userId یا خطا پرتاب می‌کند.
        const userId = await ensureRegistered();
        console.log("Received userId:", userId); // ⬅️ تست ۱ جدید: اکنون باید عدد کاربر را ببینید

        // اگر ensureRegistered خطا ندهد (یعنی کاربر موجود است و ثبت شده است)، userId را برمی‌گرداند.

        const res = await fetch(`${API_BASE}/notifications/${userId}`);
        loading.style.display = "none";

        if (!res.ok) {
          root.innerHTML = `<p class="center-msg">خطا در دریافت اعلان‌ها (Status: ${res.status})</p>`;
          return;
        }

        const data = await res.json();
        console.log("data:", data); // ⬅️ تست ۲

        if (!data.length) {
          root.innerHTML = `<p class="center-msg">اعلانی وجود ندارد</p>`;
          return;
        }

        data.forEach(n => {
          const div = document.createElement("div");
          div.className = "notif";
          // توجه: فرمت زمان را بهتر است از سرور برای نمایش تمیزتر دریافت کنید یا از توابع JS برای فرمت‌دهی استفاده کنید.
          // فعلا همانطور که از API آمده نمایش داده می‌شود.
          div.innerHTML = `
            <div>${n.text}</div>
            <div class="notif-time">${n.created_at}</div>
          `;
          root.appendChild(div);
        });
      } catch (e) {
        loading.style.display = "none"; // لودینگ را در صورت خطا پنهان کنید
        console.error("Error:", e); // ⬅️ تست ۳ (برای USER_NOT_READY یا خطاهای دیگر)
        
        // مدیریت خطاهای خاصی که از auth.js می‌آیند (مثل NOT_IN_BALE یا REDIRECT_REGISTER)
        if (e.message === "NOT_IN_BALE") {
            root.innerHTML = `<p class="center-msg">این صفحه فقط داخل بله قابل استفاده است</p>`;
        } else if (e.message === "REDIRECT_REGISTER") {
            // اگر خطا REDIRECT_REGISTER باشد، یعنی location.href در auth.js کار کرده است.
            // در این صورت، نیازی به نمایش چیزی نیست زیرا صفحه باید ریدایرکت شده باشد.
            // اگر به اینجا رسیدید، یعنی ریدایرکت کار نکرده و باید دلیل آن را بررسی کرد.
            root.innerHTML = `<p class="center-msg">به صفحه ثبت نام هدایت می‌شوید...</p>`;
            return; // توقف اجرای نمایش محتوا
        } else if (e.message === "USER_NOT_READY") {
             root.innerHTML = `<p class="center-msg">کاربر هنوز آماده نیست، لطفا کمی صبر کنید و مجدداً تلاش کنید.</p>`;
        } 
        else {
            displayError("خطای عمومی در دریافت اعلان‌ها: " + e.message);
        }
      }
    }

    function displayError(message) {
      const errorBox = document.getElementById("error-display");
      errorBox.innerText = message;
      errorBox.style.display = "block";
    }
    
    // مطمئن شوید که safeStart به درستی با ساختار جدید کار می‌کند.
    // چون ensureRegistered اکنون async است و خطا پرتاب می‌کند، منطق اصلی باید داخل try/catch باشد.
    function safeStart(fn) {
      // با توجه به اینکه loadNotifications اکنون async است، فراخوانی مستقیم آن کار می‌کند
      // و try/catch داخل آن برای مدیریت خطاهای auth.js کافی است.
      fn();
    }

    safeStart(loadNotifications);
  </script>
