<!doctype html>
<html lang="fa">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ÿæÿ≥ÿ™</title>

<link rel="stylesheet" href="style.css">

<style>
/* ===== Skeleton ===== */
.skeleton{
  background:linear-gradient(
    90deg,
    #1a1a1a 25%,
    #2a2a2a 37%,
    #1a1a1a 63%
  );
  background-size:400% 100%;
  animation:skeleton 1.4s ease infinite;
}
@keyframes skeleton{
  0%{background-position:100% 0}
  100%{background-position:0 0}
}

/* ===== Layout ===== */
.post-page{max-width:520px;margin:0 auto}
.post-media{position:relative;background:#000}
.post-media img,
.post-media video{width:100%;display:block}

/* ===== Heart Animation ===== */
.heart{
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%) scale(0);
  font-size:90px;
  opacity:0;
  pointer-events:none;
  transition:.3s;
}
.heart.show{
  transform:translate(-50%,-50%) scale(1);
  opacity:1;
}

/* ===== Header ===== */
.post-header{
  display:flex;
  align-items:center;
  gap:8px;
  padding:10px;
  font-size:14px;
}
.username{font-weight:600}

/* ===== Actions ===== */
.post-actions{padding:10px}
.action-row{
  display:flex;
  justify-content:space-between;
  font-size:22px;
}
.action-left span,
.action-right span{
  margin-left:14px;
  cursor:pointer;
}
.likes-count{font-size:14px;margin-top:6px}
.caption{font-size:14px;margin-top:4px}

/* ===== Comments ===== */
.comment-box{
  display:flex;
  align-items:center;
  gap:8px;
  margin-top:12px;
}
.comment-box input{
  flex:1;
  height:36px;
  padding:0 12px;
  border-radius:18px;
  border:none;
  background:#1c1c1c;
  color:#fff;
}
.comment-box button{
  background:none;
  border:none;
  color:var(--accent);
  font-size:14px;
  cursor:pointer;
}
.comment{font-size:14px;margin-top:4px}
.comment b{margin-left:4px}
</style>
</head>

<body>

<header class="topbar">
  <span onclick="history.back()">‚óÄ</span>
  <h1>Ÿæÿ≥ÿ™</h1>
</header>

<main class="post-page">
  <div class="post-media skeleton" id="mediaBox">
    <div class="heart" id="heart">‚ù§Ô∏è</div>
  </div>

  <div id="postBody" class="skeleton" style="height:200px"></div>
</main>

<div id="nav"></div>

<script src="auth.js"></script>
<script src="https://tapi.bale.ai/miniapp.js?3"></script>

<script>
const API_BASE = "https://insta-api-avn2.onrender.com/api";
const postId = new URLSearchParams(location.search).get("id");

const mediaBox = document.getElementById("mediaBox");
const postBody = document.getElementById("postBody");
const heart = document.getElementById("heart");

let post = null;
let lastTap = 0;

/* =====================
   Load Media FAST
===================== */
async function loadPost(){
  requireAuth();

  post = await fetch(`${API_BASE}/get_post/${postId}`).then(r=>r.json());

  mediaBox.classList.remove("skeleton");
  postBody.classList.remove("skeleton");

  mediaBox.innerHTML = `
    ${
      post.type === "video"
      ? `<video src="${API_BASE}/media_proxy?file_id=${post.video_id}"
               autoplay loop muted playsinline></video>`
      : `<img src="${API_BASE}/media_proxy?file_id=${post.photo}">`
    }
    <div class="heart" id="heart">‚ù§Ô∏è</div>
  `;

  renderBody();
  enableDoubleTap();
}

/* =====================
   Render Body
===================== */
function renderBody(){
  postBody.innerHTML = `
    <div class="post-header">
      <div class="avatar-sm"></div>
      <div class="username">${post.user_id}</div>
    </div>

    <div class="post-actions">
      <div class="action-row">
        <div class="action-left">
          <span onclick="toggleLike()">‚ù§Ô∏è</span>
          <span>üí¨</span>
          <span>üì§</span>
        </div>
        <div class="action-right">
          <span>üíæ</span>
        </div>
      </div>

      <div class="likes-count" id="likeCount">${post.likes} Ÿæÿ≥ŸÜÿØ</div>
      <div class="caption">${post.caption || ""}</div>

      <div id="comments"></div>

      <div class="comment-box">
        <input id="commentInput" placeholder="ÿßŸÅÿ≤ŸàÿØŸÜ ŸÜÿ∏ÿ±‚Ä¶">
        <button onclick="sendComment()">ÿßÿ±ÿ≥ÿßŸÑ</button>
      </div>
    </div>
  `;

  loadComments();
}

/* =====================
   Double Tap Like
===================== */
function enableDoubleTap(){
  mediaBox.onclick = ()=>{
    const now = Date.now();
    if(now - lastTap < 300){
      showHeart();
      toggleLike(true);
    }
    lastTap = now;
  };
}

function showHeart(){
  heart.classList.add("show");
  setTimeout(()=>heart.classList.remove("show"),600);
}

/* =====================
   Like (Optimistic)
===================== */
async function toggleLike(fromDoubleTap=false){
  if(fromDoubleTap){
    post.likes++;
    document.getElementById("likeCount").innerText =
      post.likes + " Ÿæÿ≥ŸÜÿØ";
  }

  const me = requireAuth();
  fetch(`${API_BASE}/like`,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ user_id:me.id, post_id:postId })
  });
}

/* =====================
   Comments
===================== */
async function loadComments(){
  const res = await fetch(`${API_BASE}/get_comments/${postId}`);
  const comments = await res.json();

  document.getElementById("comments").innerHTML =
    comments.map(c=>`
      <div class="comment">
        <b>${c.username || c.user_id}</b> ${c.text}
      </div>
    `).join("");
}

async function sendComment(){
  const me = requireAuth();
  const input = document.getElementById("commentInput");
  const text = input.value.trim();
  if(!text) return;

  input.value="";

  await fetch(`${API_BASE}/comment`,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      user_id:me.id,
      post_id:postId,
      text
    })
  });

  loadComments();
}

loadPost();

fetch("nav.html")
  .then(r=>r.text())
  .then(html=>nav.innerHTML=html);
</script>

</body>
</html>
