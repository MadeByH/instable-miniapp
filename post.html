<!doctype html>
<html lang="fa">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ù¾Ø³Øª</title>

<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

<style>
:root {
    --accent: #0095f6;
}

body {
    background: #000000;
    color: #fafafa;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
}

.post-page{
  max-width:520px;
  margin:0 auto;
}

.post-media img, .post-media video{
  width:100%;
  display:block;
  background:#000;
}

/* --- Header Bars --- */
.topbar, .comments-page-header {
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px;
  font-size:14px;
  border-bottom: 1px solid #262626;
  position: sticky;
  top: 0;
  background: #000000;
  z-index: 50;
}

.topbar h1 {
    flex:1; text-align:center; font-size:18px; margin: 0;
}

/* Post Header (User Info) */
.post-header{
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px;
  font-size:14px;
}

.post-header .username-display{
  font-weight:600;
}

/* Actions Row */
.post-actions{
  padding:8px 10px;
}

.action-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:24px;
}

.action-left i,
.action-right i{
  margin-left:16px;
  cursor:pointer;
  color: #fafafa;
  transition: color 0.2s;
}

.likes-count{
  font-size:14px;
  margin-top:6px;
  font-weight: 600;
}

.caption{
  font-size:14px;
  margin-top:4px;
}
.caption span { font-weight: 600; margin-left: 4px; }

.timeago {
    font-size: 10px;
    color: #8e8e8e;
    text-transform: uppercase;
    margin-top: 4px;
}


/* === Ø§Ø³ØªØ§ÛŒÙ„ ØµÙØ­Ù‡ Ú©Ø§Ù…Ù†Øªâ€ŒÙ‡Ø§ === */
.comments-page-header {
    top: 0;
    z-index: 50;
}
.comments-page-header h2 {
    flex: 1;
    text-align: center;
    font-size: 18px;
    margin: 0;
}

.comment-list {
    padding: 10px;
    padding-bottom: 120px; /* ÙØ¶Ø§ÛŒ Ú©Ø§ÙÛŒ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ù…Ù†Øª Ø¨Ø§Ú©Ø³ Ùˆ Ù…Ø­ØªÙˆØ§ÛŒ ÙÛŒÚ©Ø³ Ø´Ø¯Ù‡ Ø²ÛŒØ± Ø¢Ù† */
}

.comment-item{
  margin-top:15px;
  font-size:14px;
  display: flex;
}
.comment-item .avatar-sm { margin-left: 10px; flex-shrink: 0; }
.comment-item .content { flex-grow: 1; }
.comment-item .username-comment {
  font-weight: 600;
  margin-left: 4px;
}

/* Media & Header in Comments View (Top Section) */
.comments-view-top-section {
    border-bottom: 1px solid #262626;
}

/* Comment Box (Fixed Bottom) */
/* Ø¨Ù‡â€ŒØ±ÙˆØ² Ø±Ø³Ø§Ù†ÛŒ Ø§Ø³ØªØ§ÛŒÙ„ Ú©Ù„ÛŒ Ø¨Ø§Ú©Ø³ Ú©Ø§Ù…Ù†Øª Ø¯Ø± Ù¾Ø§ÛŒÛŒÙ† ØµÙØ­Ù‡ */
.comment-box-fixed {
  position: fixed;
  bottom: 0;
  left: 50%; /* Ù…Ø±Ú©Ø² Ú©Ø±Ø¯Ù† */
  transform: translateX(-50%);
  display: flex; /* Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Flexbox */
  align-items: center;
  gap: 8px;
  padding: 8px 30px; /* Ú©Ù…ÛŒ ÙØ¶Ø§ÛŒ Ø§ÙÙ‚ÛŒ Ø¨ÛŒØ´ØªØ±ØŒ Ø§ÛŒÙ† Ù…Ù‚Ø¯Ø§Ø± Ù…ÛŒâ€ŒØªÙˆÙ†Ù‡ Ú©Ù… ÛŒØ§ Ø²ÛŒØ§Ø¯ Ø´Ù‡ */
  width: 90%; /* Ø¹Ø±Ø¶ Ù†Ø³Ø¨ÛŒ Ù…Ù†Ø§Ø³Ø¨ */
  max-width: 600px; /* Ø­Ø¯Ø§Ú©Ø«Ø± Ø¹Ø±Ø¶ */
  background: #000;
  border-top: 1px solid #222;
  z-index: 1000;
  box-sizing: border-box;
  border-radius: 10px 10px 0 0; /* Ú¯ÙˆØ´Ù‡â€ŒÙ‡Ø§ÛŒ Ú¯Ø±Ø¯ */
}

/* Ø§Ø³ØªØ§ÛŒÙ„ textarea */
.comment-box-fixed textarea {
  flex: 1;
  min-height: 38px;
  max-height: 120px;
  padding: 8px 12px;
  border-radius: 18px;
  border: 1px solid #333;
  background-color: #111;
  resize: none;
  overflow-y: auto;
  color: #fff;
  font-size: 14px;
  line-height: 20px;
  font-family: inherit;
  text-align: right;
}

/* Ø§Ø³ØªØ§ÛŒÙ„ Ø¯Ú©Ù…Ù‡ Ø§Ø±Ø³Ø§Ù„ */
/* Ø§Ø³ØªØ§ÛŒÙ„ Ø¯Ú©Ù…Ù‡ Ø§Ø±Ø³Ø§Ù„ (Ù†Ø³Ø®Ù‡ Ú©ÙˆÚ†Ú©â€ŒØªØ± Ø´Ø¯Ù‡ Ùˆ Ø¨Ø§ Ø§ÙˆÙ„ÙˆÛŒØª Ø¨Ø§Ù„Ø§) */
.comment-box-fixed button {
  padding: 4px 8px; /* Ú©ÙˆÚ†Ú©â€ŒØªØ±ÛŒÙ† Ø­Ø§Ù„Øª Ø¨Ø±Ø§ÛŒ ØªØ³Øª */
  border: none;
  border-radius: 14px;
  background: var(--accent, #0095f6);
  color: #fff;
  font-size: 12px; /* Ú©ÙˆÚ†Ú©â€ŒØªØ±ÛŒÙ† ÙÙˆÙ†Øª */
  font-weight: 600;
  cursor: pointer;
  transition: opacity 0.2s ease;
  /* Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† !important Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† (Ø§Ú¯Ø± Ù‡Ù…Ú†Ù†Ø§Ù† Ú©Ø§Ø± Ù†Ú©Ø±Ø¯) */
  /* min-width: 30px !important;  ğŸ‘ˆ Ø§Ú¯Ø± Ù‡Ù†ÙˆØ² Ø¨Ø²Ø±Ú¯ Ø¨ÙˆØ¯ØŒ Ø§ÛŒÙ† Ø®Ø· Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯ */
}

.comment-box-fixed button:hover {
  opacity: 0.8;
}

.comment-box-fixed button:disabled {
  opacity: 0.4;
}

.back-btn{ cursor:pointer; }
</style>
</head>

<body>

<header class="topbar" id="headerBar">
  <span class="back-btn" onclick="handleBack()"><i class="fas fa-arrow-left"></i></span>
  <h1 id="pageTitle">Ù¾Ø³Øª</h1>
  <span style="visibility:hidden;"><i class="fas fa-arrow-left"></i></span>
</header>

<main class="post-page" id="postRoot">
  <div class="loading">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒâ€¦</div>
</main>

<!-- Ú©Ø§Ù…Ù†Øª Ø¨Ø§Ú©Ø³ ÙÛŒÚ©Ø³ Ø´Ø¯Ù‡ Ø¯Ø± Ù¾Ø§ÛŒÛŒÙ† -->
<div class="comment-box-fixed" id="commentBoxFixed">
  <textarea id="commentInput" placeholder="Ø§ÙØ²ÙˆØ¯Ù† Ø¯ÛŒØ¯Ú¯Ø§Ù‡..."></textarea>
  <button
  id="sendButton"
  onclick="sendComment(currentPostId)"
  disabled
  style="display:none"
>
  Ø§Ø±Ø³Ø§Ù„
  </button>
</div>

<div id="nav"></div>

<script src="auth.js"></script>
<script src="https://tapi.bale.ai/miniapp.js?3"></script>

<script>
const API_BASE = "https://insta-api-avn2.onrender.com/api";
if (window.Bale?.WebApp) Bale.WebApp.ready();

const root = document.getElementById("postRoot");
const headerBar = document.getElementById("headerBar");
const pageTitle = document.getElementById("pageTitle");
const fixedCommentBox = document.getElementById("commentBoxFixed");
const commentInput = document.getElementById("commentInput");
const sendButton = document.getElementById("sendButton");
const navBar = document.getElementById("nav");

commentInput.addEventListener("input", () => {
  handleCommentInput(commentInput);
});

let currentPostId = null;
let isCommentsPage = false; 
let postData = null; // Ø¨Ø±Ø§ÛŒ Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø³Øª Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø³Ø±ÛŒØ¹
let liked = false;
let saved = false;
let replyToCommentId = null;
let replyToUsername = null;

// --- Utility Functions ---

function timeAgo(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const seconds = Math.floor((now - date) / 1000);

    let interval = seconds / 31536000;
    if (interval > 1) return Math.floor(interval) + " Ø³Ø§Ù„ Ù¾ÛŒØ´";
    interval = seconds / 2592000;
    if (interval > 1) return Math.floor(interval) + " Ù…Ø§Ù‡ Ù¾ÛŒØ´";
    interval = seconds / 604800;
    if (interval > 1) return Math.floor(interval) + " Ù‡ÙØªÙ‡ Ù¾ÛŒØ´";
    interval = seconds / 86400;
    if (interval > 1) return Math.floor(interval) + " Ø±ÙˆØ² Ù¾ÛŒØ´";
    interval = seconds / 3600;
    if (interval > 1) return Math.floor(interval) + " Ø³Ø§Ø¹Øª Ù¾ÛŒØ´";
    interval = seconds / 60;
    if (interval > 1) return Math.floor(interval) + " Ø¯Ù‚ÛŒÙ‚Ù‡ Ù¾ÛŒØ´";
    return "Ù‡Ù…ÛŒÙ† Ø§Ù„Ø§Ù†";
}

function getActionIcon(state, type) {
    // type: 'like' or 'save'
    // state: true (filled) or false (outline)
    if (type === 'like') {
        return state ? 'fas fa-heart' : 'far fa-heart';
    }
    if (type === 'save') {
        return state ? 'fas fa-bookmark' : 'far fa-bookmark';
    }
    return '';
}

// --- Core Handlers ---

function updateSendButtonState() {
    const text = commentInput.value.trim();
    if (text) {
        sendButton.disabled = false;
        sendButton.style.display = 'block';
    } else {
        sendButton.disabled = true;
        sendButton.style.display = 'none';
    }
}

function handleCommentInput(el) {
  el.style.height = "36px";
  el.style.height = Math.min(el.scrollHeight, 120) + "px";

  const hasText = el.value.trim().length > 0;

  sendButton.disabled = !hasText;
  sendButton.style.display = hasText ? "block" : "none";
    }

function focusCommentInput() {
    if (!isCommentsPage) {
        openCommentsPage();
    }
    commentInput.focus();
}

async function deleteComment(commentId) {
  const me = requireAuth();

  await fetch(`${API_BASE}/delete_comment`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      comment_id: commentId,
      user_id: me.id
    })
  });

  loadPost(true);
    }

function handleBack() {
  if (isCommentsPage) {
    history.back();
    return;
  }

  // Ø§Ú¯Ø± history Ø¯Ø§Ø±ÛŒÙ…ØŒ Ø¨Ø±Ú¯Ø±Ø¯
  if (window.history.length > 1) {
    history.back();
    return;
  }

  // ÙÙ‚Ø· Ø§Ú¯Ø± ÙˆØ§Ù‚Ø¹Ø§Ù‹ Ø¬Ø§ÛŒÛŒ Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ú¯Ø´Øª Ù†Ø¨ÙˆØ¯
  if (window.Bale?.WebApp) {
    Bale.WebApp.close();
  }
    }

window.addEventListener("popstate", () => {
    if (isCommentsPage) {
        isCommentsPage = false;
        loadPost(false); 
    }
});

function startReply(commentId, username) {
  replyToCommentId = commentId;
  replyToUsername = username;

  commentInput.value = `@${username} `;
  commentInput.focus();
  updateSendButtonState();
    }

// --- ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Double Tap ---

let lastTap = 0;
function setupDoubleTap(postId) {
    const mediaContainer = document.querySelector(".post-media");
    if (!mediaContainer) return;

    mediaContainer.addEventListener("click", function(e) {
        // Ø§ÛŒÙ† Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ù…ÛŒâ€ŒØ¯Ù‡Ø¯ Ú©Ù‡ ÙÙ‚Ø· Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ø¨Ø®Ø´ Ù…Ø¯ÛŒØ§ Ø­Ø³Ø§Ø¨ Ù…ÛŒâ€ŒØ´ÙˆØ¯
        if (!e.target.closest(".post-media")) return;
        
        const now = Date.now();
        const elapsed = now - lastTap;

        if (elapsed < 300) {
            // Double Tap Detected
            lastTap = 0; 
            
            // Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ø§ÛŒØ¯ ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ø´Ù…Ø§ (Ú©Ù‡ Ù‚Ø¨Ù„Ø§Ù‹ Ø¨Ø±Ø§ÛŒ Ø¢ÛŒÚ©ÙˆÙ† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´Ø¯) Ø±Ø§ ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ú©Ù†ÛŒÙ…
            // Ø¨Ø§ ØªÙˆØ¬Ù‡ Ø¨Ù‡ Ú©Ø¯ Ø´Ù…Ø§ØŒ ÙØ±Ø¶ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ toggleAction('like', postId) Ø§Ø³Øª.
            // Ø§Ú¯Ø± ØªØ§Ø¨Ø¹ Ø´Ù…Ø§ ØµØ±ÙØ§Ù‹ toggleLike() Ø§Ø³ØªØŒ Ø§Ø² Ø¢Ù† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.
            // Ù…Ù† Ø§Ø² toggleAction('like', postId) Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ù… Ú©Ù‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Ú©Ø¯ Ù‚Ø¨Ù„ÛŒ Ø´Ù…Ø§ Ù…Ù†Ø·Ù‚ÛŒâ€ŒØªØ± Ø§Ø³Øª.
            const likeIcon = document.getElementById('likeIcon');
            if(likeIcon && !likeIcon.classList.contains('fas')) {
                toggleAction('like', postId); 
            }

        } else {
            lastTap = now;
            // Ø§Ú¯Ø± Ø¯Ø§Ø¨Ù„ ØªÙ¾ Ù†Ø¨ÙˆØ¯ØŒ ÙˆÛŒØ¯ÛŒÙˆ Ø±Ø§ Ù¾Ø®Ø´/ØªÙˆÙ‚Ù Ú©Ù†ÛŒØ¯ (Ø¯Ø± ØµÙˆØ±Øª ÙˆØ¬ÙˆØ¯ ÙˆÛŒØ¯ÛŒÙˆ)
            const vid = document.getElementById("postVideo");
            if(vid && e.target.tagName === 'VIDEO') {
                vid.paused ? vid.play() : vid.pause();
            }
        }
    });
}

// --- API & Rendering ---

async function loadPost(fullLoad = false){
    try{
        const me = requireAuth();
        const id = new URLSearchParams(location.search).get("id");
        currentPostId = id;

        const post = await fetch(`${API_BASE}/get_post/${id}`).then(r=>r.json());
        postData = post; // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¯Ø± ØªÙˆØ§Ø¨Ø¹ Ø¯ÛŒÚ¯Ø±
        
        // Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª Ø§ÙˆÙ„ÛŒÙ‡ Ù„Ø§ÛŒÚ© Ùˆ Ø°Ø®ÛŒØ±Ù‡ØŒ ÙØ±Ø¶ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ø§Ø² ÙˆØ¶Ø¹ÛŒØª Ø¯Ø±ÛŒØ§ÙØªÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
        liked = post.is_liked;
        saved = post.is_saved;
        
        // Ø¯Ø± Ø­Ø§Ù„Øª ØµÙØ­Ù‡ Ú©Ø§Ù…Ù†Øªâ€ŒÙ‡Ø§ØŒ ÙˆØ¶Ø¹ÛŒØª Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡ Ø§Ø±Ø³Ø§Ù„ ØªÙ†Ø¸ÛŒÙ… Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… (Ø¨Ù‡ Ø·ÙˆØ± Ù¾ÛŒØ´â€ŒÙØ±Ø¶ ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª Ù…Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± ØªØ§ÛŒÙ¾ Ú©Ù†Ø¯)
        if(fullLoad) {
             updateSendButtonState(); 
        }


        if (!fullLoad) {
            // Ø­Ø§Ù„Øª Ø§ÙˆÙ„ÛŒÙ‡ (Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù¾Ø³Øª Ø¯Ø± ÙÛŒØ¯)
            headerBar.style.display = 'flex';
            fixedCommentBox.style.display = 'none';
            pageTitle.innerText = 'Ù¾Ø³Øª';
            navBar.style.display = "block";
            
            root.innerHTML = `
              <div class="post-media">
                ${
                  post.type === "video"
                  ? `<video id="postVideo" src="${API_BASE}/media_proxy?file_id=${post.video_id}" muted loop playsinline></video>`
                  : `<img src="${API_BASE}/media_proxy?file_id=${post.photo}">`
                }
              </div>

              <div class="post-header">
                <div class="avatar-sm">
  ${
    post.user.avatar
      ? `<img src="${API_BASE}/media_proxy?file_id=${post.user.avatar}">`
      : ""
  }
</div>
                <div class="username-display">
  ${post.user.display_name || post.user.username}
</div>
              </div>

              <div class="post-actions">
                <div class="action-row">
                  <div class="action-left">
                    <i id="likeIcon"
   class="${getActionIcon(liked, 'like')}"
   onclick="toggleLike()"></i>
                    <i class="far fa-comment" onclick="openCommentsPage()"></i> 
                    <i class="far fa-paper-plane"></i>
                  </div>
                  <div class="action-right">
                    <i id="saveIcon"
   class="${getActionIcon(saved, 'save')}"
   onclick="toggleSave()"></i>
                  </div>
                </div>

                <div class="likes-count">
                  ${post.likes} Ù¾Ø³Ù†Ø¯
                </div>

                <div class="timeago">${timeAgo(post.created_at)}</div> <!-- Ø²Ù…Ø§Ù† Ù¾Ø³Øª -->

                <div class="caption">
                  <b>${post.user.display_name || post.user.username}</b>
                  ${post.caption ? post.caption.substring(0, 100) + (post.caption.length > 100 ? '...' : '') : ''}
                </div>
                
                <div class="comments" id="comments">
                    <div style="font-size: 12px; color: #8e8e8e; cursor: pointer;" onclick="openCommentsPage()">
                        Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù‡Ù…Ù‡ ${post.comments.length} Ø¯ÛŒØ¯Ú¯Ø§Ù‡
                    </div>
                </div>
              </div>
            `;
             const vid = document.getElementById("postVideo");
             if(vid) vid.onclick = ()=>{ vid.muted = !vid.muted; };

             // *** ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ø¨Ø±Ø§ÛŒ ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø¯Ø§Ø¨Ù„ ØªÙ¾ ***
             if(post.post_id) {
                 setupDoubleTap(post.post_id);
    }
        } else {
            // Ø­Ø§Ù„Øª ØµÙØ­Ù‡ Ú©Ø§Ù…Ù†Øªâ€ŒÙ‡Ø§ (fullLoad = true)
            isCommentsPage = true;
            headerBar.style.display = 'none'; // Ù‡Ø¯Ø± Ø§ØµÙ„ÛŒ Ù¾Ù†Ù‡Ø§Ù†ØŒ Ù‡Ø¯Ø± ØµÙØ­Ù‡ Ú©Ø§Ù…Ù†Øªâ€ŒÙ‡Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
            fixedCommentBox.style.display = 'flex';
            pageTitle.innerText = 'Ø¯ÛŒØ¯Ú¯Ø§Ù‡â€ŒÙ‡Ø§';
            navBar.style.display = "none";

            const commentsPageHeader = `
  <div class="comments-page-header">
    <span onclick="handleBack()">
      <i class="fas fa-arrow-left"></i>
    </span>
    <h2>Ø¯ÛŒØ¯Ú¯Ø§Ù‡â€ŒÙ‡Ø§</h2>
    <span style="visibility:hidden;">
      <i class="fas fa-arrow-left"></i>
    </span>
  </div>
`;
            
            // --- Ø³Ø§Ø®ØªØ§Ø± Ø¨Ø§Ù„Ø§ÛŒ ØµÙØ­Ù‡ Ú©Ø§Ù…Ù†Øªâ€ŒÙ‡Ø§ (Ù…Ø¯ÛŒØ§ Ùˆ Ù‡Ø¯Ø± Ù¾Ø³Øª) ---
            const commentsHeaderSection = `
                <div class="comments-view-top-section">
                    <div class="post-media">
                      ${
                        post.type === "video"
                        ? `<video src="${API_BASE}/media_proxy?file_id=${post.video_id}" muted loop playsinline style="max-height: 300px; object-fit: contain;"></video>`
                        : `<img src="${API_BASE}/media_proxy?file_id=${post.photo}" style="max-height: 300px; object-fit: contain;">`
                      }
                    </div>

                    <div class="post-header">
                      <div class="avatar-sm">
  ${
    post.user.avatar
      ? `<img src="${API_BASE}/media_proxy?file_id=${post.user.avatar}">`
      : ""
  }
</div>
                      <div class="username-display">
  ${post.user.display_name || post.user.username}
</div>
                    </div>

                    <div class="post-actions" style="padding-top: 0;">
                        <div class="action-row">
                          <div class="action-left">
                            <i id="likeIcon"
   class="${getActionIcon(liked, 'like')}"
   onclick="toggleLike()"></i>
                            <i class="far fa-comment" onclick="focusCommentInput()"></i> 
                            <i class="far fa-paper-plane"></i>
                          </div>
                          <div class="action-right">
                            <i id="saveIcon"
   class="${getActionIcon(saved, 'save')}"
   onclick="toggleSave()"></i>
                          </div>
                        </div>
                        <div class="likes-count">${post.likes} Ù¾Ø³Ù†Ø¯</div>
                        <div class="timeago">${timeAgo(post.created_at)}</div>
                        <div class="caption"><b>${post.user.display_name || post.user.username}</b> ${post.caption || ""}</div>
                    </div>
                </div>
            `;
            
            const commentItemsHtml = post.comments.map(c => {
  const commentTime = timeAgo(c.timestamp);

  return `
    <div class="comment-item">
      <div class="avatar-sm">
        ${
          c.avatar
            ? `<img src="${API_BASE}/media_proxy?file_id=${c.avatar}">`
            : ""
        }
      </div>

      <div class="content">
        <span class="username-comment">${c.username || c.user_id}</span>
        ${c.text}

        <div style="font-size:12px;color:#8e8e8e;margin-top:4px;">
          ${
            c.user_id === me.id
              ? `<span
                   onclick="deleteComment(${c.comment_id})"
                   style="margin-left:8px;color:#f55;cursor:pointer"
                 >Ø­Ø°Ù</span>`
              : ""
          }

          <span
            class="reply-btn"
            onclick="startReply(${c.comment_id}, ${JSON.stringify(c.username)})"
          >
            Ù¾Ø§Ø³Ø® Ø¯Ø§Ø¯Ù†
          </span>
          â€¢ ${commentTime}
        </div>
      </div>
    </div>
  `;
}).join("");
            
            root.innerHTML =
  commentsPageHeader +
  commentsHeaderSection +
  `<div class="comment-list">${commentItemsHtml}</div>`;
            
            // Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨Ù‡ Ù¾Ø§ÛŒÛŒÙ† Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø§Ú©Ø³ Ú©Ø§Ù…Ù†Øª
            setTimeout(() => {
                window.scrollTo(0, document.body.scrollHeight);
            }, 50);
        }

    }catch(e){
        console.error(e);
        root.innerHTML = `<p class="center-msg" style="padding: 20px;">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾Ø³Øª</p>`;
        fixedCommentBox.style.display = 'none';
    }
}

async function toggleLike(){
  const me = requireAuth();
  liked = !liked;

  const icon = document.getElementById("likeIcon");
  icon.className = getActionIcon(liked, "like");

  const countEl = document.querySelector(".likes-count");
  let count = parseInt(countEl.innerText);
  countEl.innerText = liked
    ? `${count + 1} Ù¾Ø³Ù†Ø¯`
    : `${count - 1} Ù¾Ø³Ù†Ø¯`;

  fetch(`${API_BASE}/like`,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      user_id: me.id,
      post_id: currentPostId
    })
  });
    }

async function toggleSave(){
  const me = requireAuth();
  saved = !saved;

  const icon = document.getElementById("saveIcon");
  icon.className = getActionIcon(saved, "save");

  fetch(`${API_BASE}/save`,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      user_id: me.id,
      post_id: currentPostId
    })
  });
    }

async function sendComment(postId){
  const me = requireAuth();
  const text = commentInput.value.trim();
  if(!text) return;
  
  await fetch(`${API_BASE}/comment`,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ user_id: me.id, post_id: postId, text })
  });

  commentInput.value = "";
  updateSendButtonState();
  
  // Ø±ÙØ±Ø´ ØµÙØ­Ù‡ Ú©Ø§Ù…Ù†Øªâ€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ú©Ø§Ù…Ù†Øª Ø¬Ø¯ÛŒØ¯
  if(isCommentsPage) {
      loadPost(true);
  } else {
      loadPost(false);
  }
}

async function openCommentsPage(){
    if (isCommentsPage || !currentPostId) return;
    
    isCommentsPage = true;
    
    // ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ù…Ø±ÙˆØ±Ú¯Ø± Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ú©Ù…Ù‡ Ø¨Ø§Ø²Ú¯Ø´Øª
    history.pushState({}, '', `?id=${currentPostId}`);

    // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¬Ø¯Ø¯ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù†Ù…Ø§ÛŒ Ú©Ø§Ù…Ù„ Ú©Ø§Ù…Ù†Øªâ€ŒÙ‡Ø§
    await loadPost(true); 
}


fetch("nav.html")
  .then(r=>r.text())
  .then(html=>nav.innerHTML=html);

loadPost(false); // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø¯Ø± Ø­Ø§Ù„Øª Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù¾Ø³Øª
</script>

</body>
</html>
