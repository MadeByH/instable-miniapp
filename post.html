<!doctype html>
<html lang="fa">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>پست</title>

<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

<style>
:root {
    --accent: #0095f6;
}

body {
    background: #000000;
    color: #fafafa;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
}

.post-page{
  max-width:520px;
  margin:0 auto;
}

.post-media img, .post-media video{
  width:100%;
  display:block;
  background:#000;
}

/* --- Header Bars --- */
.topbar, .comments-page-header {
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px;
  font-size:14px;
  border-bottom: 1px solid #262626;
  position: sticky;
  top: 0;
  background: #000000;
  z-index: 50;
}

.topbar h1 {
    flex:1; text-align:center; font-size:18px; margin: 0;
}

/* Post Header (User Info) */
.post-header{
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px;
  font-size:14px;
}

.post-header .username-display{
  font-weight:600;
}

/* Actions Row */
.post-actions{
  padding:8px 10px;
}

.action-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:24px;
}

.action-left i,
.action-right i{
  margin-left:16px;
  cursor:pointer;
  color: #fafafa;
  transition: color 0.2s;
}

.likes-count{
  font-size:14px;
  margin-top:6px;
  font-weight: 600;
}

.caption{
  font-size:14px;
  margin-top:4px;
}
.caption span { font-weight: 600; margin-left: 4px; }

.timeago {
    font-size: 10px;
    color: #8e8e8e;
    text-transform: uppercase;
    margin-top: 4px;
}


/* === استایل صفحه کامنت‌ها === */
.comments-page-header {
    top: 0;
    z-index: 50;
}
.comments-page-header h2 {
    flex: 1;
    text-align: center;
    font-size: 18px;
    margin: 0;
}

.comment-list {
    padding: 10px;
    padding-bottom: 120px; /* فضای کافی برای کامنت باکس و محتوای فیکس شده زیر آن */
}

.comment-item{
  margin-top:15px;
  font-size:14px;
  display: flex;
}
.comment-item .avatar-sm { margin-left: 10px; flex-shrink: 0; }
.comment-item .content { flex-grow: 1; }
.comment-item .username-comment {
  font-weight: 600;
  margin-left: 4px;
}

/* Media & Header in Comments View (Top Section) */
.comments-view-top-section {
    border-bottom: 1px solid #262626;
}

/* Comment Box (Fixed Bottom) */
@media (max-height: 600px) {
.comment-box-fixed-bottom {
    bottom: env(safe-area-inset-bottom);
    left: 0;
    right: 0;
    max-width: 520px;
    margin: 0 auto;
    padding: 10px 15px;
    background: #000000;
    border-top: 1px solid #262626;
    display: flex;
    align-items: center;
    gap: 8px;
    z-index: 60;
}
}
.comment-box-fixed-bottom .avatar-sm { flex-shrink: 0; }

.comment-box-fixed-bottom input{
  flex:1;
  padding: 8px 12px;
  border-radius: 20px;
  border: 1px solid #3a3a3a;
  background: #1c1c1c;
  color: #fff;
  font-size: 14px;
  outline: none;
}

.comment-box-fixed-bottom button{
  padding: 0 14px;
  height: 36px;
  border-radius: 18px;
  border:none;
  background: none;
  color: var(--accent);
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  display: none; /* مخفی است تا زمانی که متن وارد شود */
}

.comment-box-fixed-bottom button:disabled {
    opacity: 0.3;
    cursor: not-allowed;
}

.back-btn{ cursor:pointer; }
</style>
</head>

<body>

<header class="topbar" id="headerBar">
  <span class="back-btn" onclick="handleBack()"><i class="fas fa-arrow-left"></i></span>
  <h1 id="pageTitle">پست</h1>
  <span style="visibility:hidden;"><i class="fas fa-arrow-left"></i></span>
</header>

<main class="post-page" id="postRoot">
  <div class="loading">در حال بارگذاری…</div>
</main>

<!-- کامنت باکس فیکس شده در پایین -->
<div id="commentBoxFixed" class="comment-box-fixed-bottom">
    <div class="avatar-sm"></div>
    <input id="commentInput" placeholder="افزودن نظر…" oninput="handleCommentInput(this)">
    <button id="sendButton" onclick="sendComment(currentPostId)" disabled>ارسال</button>
</div>

<div id="nav"></div>

<script src="auth.js"></script>
<script src="https://tapi.bale.ai/miniapp.js?3"></script>

<script>
const API_BASE = "https://insta-api-avn2.onrender.com/api";
if (window.Bale?.WebApp) Bale.WebApp.ready();

const root = document.getElementById("postRoot");
const headerBar = document.getElementById("headerBar");
const pageTitle = document.getElementById("pageTitle");
const fixedCommentBox = document.getElementById("commentBoxFixed");
const commentInput = document.getElementById("commentInput");
const sendButton = document.getElementById("sendButton");

let currentPostId = null;
let isCommentsPage = false; 
let postData = null; // برای نگهداری داده‌های پست برای دسترسی سریع
let liked = false;
let saved = false;

// --- Utility Functions ---

function timeAgo(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const seconds = Math.floor((now - date) / 1000);

    let interval = seconds / 31536000;
    if (interval > 1) return Math.floor(interval) + " سال پیش";
    interval = seconds / 2592000;
    if (interval > 1) return Math.floor(interval) + " ماه پیش";
    interval = seconds / 604800;
    if (interval > 1) return Math.floor(interval) + " هفته پیش";
    interval = seconds / 86400;
    if (interval > 1) return Math.floor(interval) + " روز پیش";
    interval = seconds / 3600;
    if (interval > 1) return Math.floor(interval) + " ساعت پیش";
    interval = seconds / 60;
    if (interval > 1) return Math.floor(interval) + " دقیقه پیش";
    return "همین الان";
}

function getActionIcon(state, type) {
    // type: 'like' or 'save'
    // state: true (filled) or false (outline)
    if (type === 'like') {
        return state ? 'fas fa-heart' : 'far fa-heart';
    }
    if (type === 'save') {
        return state ? 'fas fa-bookmark' : 'far fa-bookmark';
    }
    return '';
}

// --- Core Handlers ---

function updateSendButtonState() {
    const text = commentInput.value.trim();
    if (text) {
        sendButton.disabled = false;
        sendButton.style.display = 'block';
    } else {
        sendButton.disabled = true;
        sendButton.style.display = 'none';
    }
}

function handleCommentInput(inputElement) {
    updateSendButtonState();
}

function focusCommentInput() {
    if (!isCommentsPage) {
        openCommentsPage();
    }
    commentInput.focus();
}

function handleBack() {
    if (isCommentsPage) {
        history.back();
    } else {
        // رفتار پیش‌فرض برای برگشت به صفحه قبلی در اپلیکیشن
        if (window.Bale?.WebApp) {
            Bale.WebApp.close();
        } else {
            window.history.back();
        }
    }
}

window.addEventListener("popstate", () => {
    if (isCommentsPage) {
        isCommentsPage = false;
        loadPost(false); 
    }
});

// --- API & Rendering ---

async function loadPost(fullLoad = false){
    try{
        const me = requireAuth();
        const id = new URLSearchParams(location.search).get("id");
        currentPostId = id;

        const post = await fetch(`${API_BASE}/get_post/${id}`).then(r=>r.json());
        postData = post; // ذخیره داده‌ها برای استفاده در توابع دیگر
        
        // برای نمایش وضعیت اولیه لایک و ذخیره، فرض می‌کنیم از وضعیت دریافتی استفاده می‌کنیم
        liked = post.is_liked;
        saved = post.is_saved;
        
        // در حالت صفحه کامنت‌ها، وضعیت را برای دکمه ارسال تنظیم می‌کنیم (به طور پیش‌فرض غیرفعال است مگر کاربر تایپ کند)
        if(fullLoad) {
             updateSendButtonState(); 
        }


        if (!fullLoad) {
            // حالت اولیه (مشاهده پست در فید)
            headerBar.style.display = 'flex';
            fixedCommentBox.style.display = 'none';
            pageTitle.innerText = 'پست';
            
            root.innerHTML = `
              <div class="comments-page-header">
                <span onclick="handleBack()">
                  <i class="fas fa-arrow-left"></i>
                </span>
                <h2>دیدگاه‌ها</h2>
                <span style="visibility:hidden;">
                  <i class="fas fa-arrow-left"></i>
                </span>
              </div>
              <div class="post-media">
                ${
                  post.type === "video"
                  ? `<video id="postVideo" src="${API_BASE}/media_proxy?file_id=${post.video_id}" muted loop playsinline></video>`
                  : `<img src="${API_BASE}/media_proxy?file_id=${post.photo}">`
                }
              </div>

              <div class="post-header">
                <div class="avatar-sm"></div>
                <div class="username-display">${post.display_name || post.user_id}</div> <!-- استفاده از نام نمایشی -->
              </div>

              <div class="post-actions">
                <div class="action-row">
                  <div class="action-left">
                    <i id="likeIcon"
   class="${getActionIcon(liked, 'like')}"
   onclick="toggleLike()"></i>
                    <i class="far fa-comment" onclick="openCommentsPage()"></i> 
                    <i class="far fa-paper-plane"></i>
                  </div>
                  <div class="action-right">
                    <i id="saveIcon"
   class="${getActionIcon(saved, 'save')}"
   onclick="toggleSave()"></i>
                  </div>
                </div>

                <div class="likes-count">
                  ${post.likes} پسند
                </div>

                <div class="timeago">${timeAgo(post.created_at)}</div> <!-- زمان پست -->

                <div class="caption">
                  <b>${post.display_name || post.user_id}</b> 
                  ${post.caption ? post.caption.substring(0, 100) + (post.caption.length > 100 ? '...' : '') : ''}
                </div>
                
                <div class="comments" id="comments">
                    <div style="font-size: 12px; color: #8e8e8e; cursor: pointer;" onclick="openCommentsPage()">
                        مشاهده همه ${post.comments.length} دیدگاه
                    </div>
                </div>
              </div>
            `;
             const vid = document.getElementById("postVideo");
             if(vid) vid.onclick = ()=>{ vid.muted = !vid.muted; };

        } else {
            // حالت صفحه کامنت‌ها (fullLoad = true)
            isCommentsPage = true;
            headerBar.style.display = 'none'; // هدر اصلی پنهان، هدر صفحه کامنت‌ها نمایش داده می‌شود
            fixedCommentBox.style.display = 'flex';
            pageTitle.innerText = 'دیدگاه‌ها';
            
            // --- ساختار بالای صفحه کامنت‌ها (مدیا و هدر پست) ---
            const commentsHeaderSection = `
                <div class="comments-view-top-section">
                    <div class="post-media">
                      ${
                        post.type === "video"
                        ? `<video src="${API_BASE}/media_proxy?file_id=${post.video_id}" muted loop playsinline style="max-height: 300px; object-fit: contain;"></video>`
                        : `<img src="${API_BASE}/media_proxy?file_id=${post.photo}" style="max-height: 300px; object-fit: contain;">`
                      }
                    </div>

                    <div class="post-header">
                      <div class="avatar-sm"></div>
                      <div class="username-display">${post.display_name || post.user_id}</div>
                    </div>

                    <div class="post-actions" style="padding-top: 0;">
                        <div class="action-row">
                          <div class="action-left">
                            <i id="likeIcon"
   class="${getActionIcon(liked, 'like')}"
   onclick="toggleLike()"></i>
                            <i class="far fa-comment" onclick="focusCommentInput()"></i> 
                            <i class="far fa-paper-plane"></i>
                          </div>
                          <div class="action-right">
                            <i id="saveIcon"
   class="${getActionIcon(saved, 'save')}"
   onclick="toggleSave()"></i>
                          </div>
                        </div>
                        <div class="likes-count">${post.likes} پسند</div>
                        <div class="timeago">${timeAgo(post.created_at)}</div>
                        <div class="caption"><b>${post.display_name || post.user_id}</b> ${post.caption || ""}</div>
                    </div>
                </div>
            `;
            
            const commentItemsHtml = post.comments.map(c => {
                const commentTime = timeAgo(c.created_at || new Date().toISOString());
                return `
                  <div class="comment-item">
                    <div class="avatar-sm"></div>
                    <div class="content">
                        <span class="username-comment">${c.display_name || c.user_id}</span> ${c.text}
                        <div style="font-size: 12px; color: #8e8e8e; margin-top: 4px;">
                            <span style="font-weight: bold; margin-left: 6px; cursor: pointer;">پاسخ دادن</span> • ${commentTime}
                        </div>
                    </div>
                  </div>
                `;
            }).join("");
            
            root.innerHTML = commentsHeaderSection + `<div class="comment-list">${commentItemsHtml}</div>`;
            
            // اسکرول به پایین برای نمایش باکس کامنت
            setTimeout(() => {
                window.scrollTo(0, document.body.scrollHeight);
            }, 50);
        }

    }catch(e){
        console.error(e);
        root.innerHTML = `<p class="center-msg" style="padding: 20px;">خطا در بارگذاری پست</p>`;
        fixedCommentBox.style.display = 'none';
    }
}

async function toggleLike(){
  const me = requireAuth();
  liked = !liked;

  const icon = document.getElementById("likeIcon");
  icon.className = getActionIcon(liked, "like");

  const countEl = document.querySelector(".likes-count");
  let count = parseInt(countEl.innerText);
  countEl.innerText = liked
    ? `${count + 1} پسند`
    : `${count - 1} پسند`;

  fetch(`${API_BASE}/like`,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      user_id: me.id,
      post_id: currentPostId
    })
  });
    }

async function toggleSave(){
  const me = requireAuth();
  saved = !saved;

  const icon = document.getElementById("saveIcon");
  icon.className = getActionIcon(saved, "save");

  fetch(`${API_BASE}/save`,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      user_id: me.id,
      post_id: currentPostId
    })
  });
    }

async function sendComment(postId){
  const me = requireAuth();
  const text = commentInput.value.trim();
  if(!text) return;
  
  await fetch(`${API_BASE}/comment`,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ user_id: me.id, post_id: postId, text })
  });

  commentInput.value = "";
  updateSendButtonState();
  
  // رفرش صفحه کامنت‌ها برای نمایش کامنت جدید
  if(isCommentsPage) {
      loadPost(true);
  } else {
      loadPost(false);
  }
}

async function openCommentsPage(){
    if (isCommentsPage || !currentPostId) return;
    
    isCommentsPage = true;
    
    // تغییر وضعیت مرورگر برای مدیریت دکمه بازگشت
    history.pushState({}, '', `?id=${currentPostId}`);

    // بارگذاری مجدد برای نمایش نمای کامل کامنت‌ها
    await loadPost(true); 
}


fetch("nav.html")
  .then(r=>r.text())
  .then(html=>nav.innerHTML=html);

loadPost(false); // بارگذاری اولیه در حالت مشاهده پست
</script>

</body>
</html>
