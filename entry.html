<!doctype html>
<html lang="fa">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>در حال ورود…</title>
  <link rel="stylesheet" href="style.css">
</head>
<body class="entry-page">

  <div class="entry-bg"></div>

  <div class="entry-center">
    <img
      src="https://i.ibb.co/svpxxh7T/image.png"
      class="entry-logo"
      alt="Instagram"
    >
  </div>

  <div class="entry-footer">
    <span>from</span>
    <img
      src="https://i.ibb.co/mVGvs35P/image.png"
      class="meta-logo"
      alt="Meta"
    >
  </div>

<script src="https://tapi.bale.ai/miniapp.js?3"></script>

<script>
const API_BASE = "https://insta-api-avn2.onrender.com/api";

function show(msg){
  document.body.innerHTML = `<p style="padding:20px;text-align:center">${msg}</p>`;
}

(async () => {
  if (!window.Bale?.WebApp) {
    show("❌ این برنامه فقط داخل بله اجرا می‌شود");
    return;
  }

  Bale.WebApp.ready();

  const data = Bale.WebApp.initDataUnsafe;
  const user = data?.user;

  if (!user?.id) {
    show("⏳ اطلاعات کاربر هنوز آماده نیست، صفحه را ببندید و دوباره باز کنید");
    return;
  }

  // ذخیره‌ی اطلاعات کاربر
  sessionStorage.setItem("bale_user", JSON.stringify({
    id: user.id,
    username: user.username || "",
    first_name: user.first_name || ""
  }));

  // بررسی ثبت‌نام
  const res = await fetch(`${API_BASE}/user_exists/${user.id}`);
  const j = await res.json();

  if (!j.exists) {
    location.replace("register.html");
  } else {
    location.replace("home.html");
  }
})();
</script>

</body>
</html>
