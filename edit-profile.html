<!doctype html>
<html lang="fa">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ویرایش پروفایل</title>
<link rel="stylesheet" href="style.css">
<link rel="stylesheet"
 href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>

<body>

<header class="topbar">
  <span class="back-btn" onclick="history.back()">
    <i class="fas fa-arrow-right"></i>
  </span>
  <h1>ویرایش پروفایل</h1>
</header>

<main class="card" style="margin:20px;">
  <img id="avatar" class="avatar editable"
     src="https://via.placeholder.com/110">

<p class="change-avatar">تغییر عکس پروفایل</p>

  <input id="displayName" placeholder="نام نمایشی">
  <textarea id="bio" placeholder="بیو"></textarea>

  <button onclick="saveProfile()">ذخیره تغییرات</button>
  <p id="msg" class="center-msg"></p>
</main>

<script src="auth.js"></script>

<script src="https://tapi.bale.ai/miniapp.js?3"></script>
<script>
const me = requireAuth();

function openAvatarBot(){
  Bale.WebApp.openLink(
    `https://ble.ir/baleinstagram_bot?start=new_profile_pic_${me.id}`
  );

  setTimeout(()=>Bale.WebApp.close(), 300);
}

avatar.onclick = openAvatarBot;
document.querySelector(".change-avatar").onclick = openAvatarBot;
 </script>
 
<script>
const API_BASE = "https://insta-api-avn2.onrender.com/api";

async function loadProfile(){
  const me = requireAuth();
  const user = await fetch(`${API_BASE}/get_user/${me.id}`).then(r=>r.json());

  displayName.value = user.display_name;
  bio.value = user.bio || "";

  if(user.profile_pic){
    avatar.src = `${API_BASE}/media_proxy?file_id=${user.profile_pic}`;
    uploadedFileId = user.profile_pic;
  }
}

async function saveProfile(){
  msg.innerText = "در حال ذخیره…";

  try{
    const me = requireAuth();

    const res = await fetch(`${API_BASE}/update_profile`,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        user_id: me.id,
        display_name: displayName.value.trim(),
        bio: bio.value.trim()
      })
    });

    if(!res.ok) throw "";

    location.replace("profile.html");

  }catch{
    msg.innerText = "خطا در ذخیره اطلاعات";
  }
}

loadProfile();
</script>

</body>
</html>
