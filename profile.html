<!doctype html>
<html lang="fa">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>پروفایل</title>
<link rel="stylesheet" href="style.css">
</head>

<body>

<header class="topbar">
  <h1>پروفایل</h1>
</header>

<main>
  <div id="profile-root"></div>
  <div id="profile-posts" class="grid"></div>
  <div id="loading" class="loading">در حال بارگذاری…</div>
</main>

<div id="nav"></div>

<script src="auth.js"></script>
<script>
const API_BASE = "https://insta-api-avn2.onrender.com/api";

async function loadProfile(){
  const root = document.getElementById("profile-root");
  const postsEl = document.getElementById("profile-posts");
  const loading = document.getElementById("loading");

  try{
    const me = requireAuth();

    const targetId =
      new URLSearchParams(location.search).get("user_id") || me.id;

    const user = await fetch(`${API_BASE}/get_user/${targetId}`).then(r=>r.json());
    const posts = await fetch(`${API_BASE}/get_user_posts/${targetId}`).then(r=>r.json());

    loading.style.display="none";

    root.innerHTML = `
      <div class="profile-head">
        <img class="avatar" src="${
          user.profile_pic
          ? `${API_BASE}/media_proxy?file_id=${user.profile_pic}`
          : 'https://via.placeholder.com/110'
        }">
        <div>
          <h3>${user.display_name}</h3>
          <p>@${user.username}</p>
          <p>${user.bio || ""}</p>
          <small>${user.followers} دنبال‌کننده · ${user.following} دنبال‌شده</small>
        </div>
      </div>
    `;

    postsEl.innerHTML="";
    posts.forEach(p=>{
      const img=document.createElement("img");
      img.src = p.photo
        ? `${API_BASE}/media_proxy?file_id=${p.photo}`
        : "https://via.placeholder.com/300";
      postsEl.appendChild(img);
    });

  }catch(e){
    loading.style.display="none";
    root.innerHTML=`<p class="center-msg">خطا در بارگذاری پروفایل</p>`;
  }
}

loadProfile();
</script>

<script>
fetch("nav.html")
  .then(r=>r.text())
  .then(html=>nav.innerHTML=html);
</script>

</body>
</html>
