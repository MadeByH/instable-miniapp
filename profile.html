<!doctype html>
<html lang="fa">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>پروفایل</title>
<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<body>

<header class="topbar">
  <h1>پروفایل</h1>
</header>

<main>
  <div id="profile-root"></div>
  <div id="profile-posts" class="profile-grid"></div>
  <div id="loading" class="loading">در حال بارگذاری…</div>
</main>

<div id="nav"></div>

<script src="auth.js"></script>
<script>
const API_BASE = "https://insta-api-avn2.onrender.com/api";

async function loadProfile(){
  const root = document.getElementById("profile-root");
  const postsEl = document.getElementById("profile-posts");
  const loading = document.getElementById("loading");

  loading.style.display = "block";

  try{
    const me = requireAuth();
    const targetId =
      new URLSearchParams(location.search).get("user_id") || me.id;

    const isMe = String(me.id) === String(targetId);

    // 1️⃣ اول HTML رو بساز
    root.innerHTML = `
      <div class="profile-box">
        <div class="profile-top">
          <img class="avatar-lg" id="profileAvatar">

          <div class="profile-stats">
            <div><b id="postCount">0</b><span>پست</span></div>
            <div><b id="followerCount">0</b><span>دنبال‌کننده</span></div>
            <div><b id="followingCount">0</b><span>دنبال‌شده</span></div>
          </div>
        </div>

        <div class="profile-info">
          <div class="profile-name" id="displayName"></div>
          <div class="profile-bio" id="bio"></div>
        </div>

        <div class="profile-actions" id="profileActions"></div>
      </div>
    `;

    // 2️⃣ حالا المنت‌ها واقعاً وجود دارن
    const profileAvatar = document.getElementById("profileAvatar");
    const displayName = document.getElementById("displayName");
    const bio = document.getElementById("bio");
    const postCount = document.getElementById("postCount");
    const followerCount = document.getElementById("followerCount");
    const followingCount = document.getElementById("followingCount");
    const profileActions = document.getElementById("profileActions");

    // 3️⃣ دیتا بگیر
    const user = await fetch(`${API_BASE}/get_user/${targetId}`).then(r=>r.json());
    const posts = await fetch(`${API_BASE}/get_user_posts/${targetId}`).then(r=>r.json());

    document.querySelector(".topbar h1").innerText =
  isMe ? "پروفایل" : user.username;

    // 4️⃣ پر کردن اطلاعات
    profileAvatar.src = user.profile_pic
      ? `${API_BASE}/media_proxy?file_id=${user.profile_pic}`
      : "https://via.placeholder.com/110";

    profileAvatar.onclick = () => {
  window.open(profileAvatar.src, "_blank");
};

    displayName.innerText = user.display_name;
    bio.innerText = user.bio || "";

    postCount.innerText = posts.length;
    followerCount.innerText = user.followers || 0;
    followingCount.innerText = user.following || 0;

    // 5️⃣ دکمه‌ها
    if(isMe){
      profileActions.innerHTML = `
        <button onclick="location.href='edit-profile.html'">
          ویرایش پروفایل
        </button>
      `;
    }else{
  const f = await fetch(
    `${API_BASE}/is_following?viewer=${me.id}&target=${targetId}`
  ).then(r=>r.json());

  profileActions.innerHTML = `
    <button onclick="toggleFollow(${targetId})">
      ${f.is_following ? "دنبال‌شده" : "دنبال کردن"}
    </button>

    <button class="secondary"
      onclick="openChat('${user.username}')">
      پیام دادن
    </button>
  `;
    }

    // 6️⃣ گرید پست‌ها
    posts.forEach(p => {
  const wrap = document.createElement("div");
  wrap.className = "profile-post-item";

  let media;

  if (p.type === "video") {
    media = document.createElement("video");
    media.src = `${API_BASE}/media_proxy?file_id=${p.video_id}`;
    media.muted = true;
    media.loop = true;
    media.autoplay = true;
    media.playsInline = true;
    media.preload = "metadata";
    media.loading = " lazy";
  } else {
    media = document.createElement("img");
    media.src = `${API_BASE}/media_proxy?file_id=${p.photo}`;
  }

  media.onclick = () =>
    location.href = `post.html?id=${p.post_id}`;

  wrap.appendChild(media);

  // آیکن ویدیو (FontAwesome)
  if (p.type === "video") {
    const icon = document.createElement("i");
    icon.className = "fas fa-play video-icon";
    wrap.appendChild(icon);
  }

  postsEl.appendChild(wrap);
});

    if (posts.length === 0) {
  postsEl.classList.add("empty");
  postsEl.innerHTML = `<p style="opacity:.6">هنوز پستی منتشر نشده</p>`;
}

    loading.style.display = "none";

  }catch(e){
    loading.style.display="none";
    root.innerHTML=`<p class="center-msg">خطا در بارگذاری پروفایل</p>`;
  }
}

function openChat(username){
  if (!window.Bale?.WebApp) {
    // fallback برای مرورگر
    window.open(`https://ble.ir/${username}`, "_blank");
    return;
  }

  Bale.WebApp.openLink(
    `https://ble.ir/${username}`
  );

  // اختیاری: بستن مینی‌اپ
  setTimeout(() => Bale.WebApp.close(), 300);
}

loadProfile();
</script>

<script>
fetch("nav.html")
  .then(r=>r.text())
  .then(html=>nav.innerHTML=html);
</script>

</body>
</html>
