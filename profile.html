async function loadProfile(){
  const root = document.getElementById("profile-root");
  const postsEl = document.getElementById("profile-posts");
  const loading = document.getElementById("loading");

  const auth = await ensureRegistered();
  if (!auth.ok) {
    loading.style.display="none";
    return;
  }

  const targetId =
    new URLSearchParams(location.search).get("user_id") || auth.userId;

  const user = await fetch(`${API_BASE}/get_user/${targetId}`).then(r=>r.json());
  const posts = await fetch(`${API_BASE}/get_user_posts/${targetId}`).then(r=>r.json());

  loading.style.display="none";

  root.innerHTML = `
    <div class="profile-head">
      <img class="avatar" src="${
        user.profile_pic
        ? `${API_BASE}/media_proxy?file_id=${user.profile_pic}`
        : 'https://via.placeholder.com/90'
      }">
      <div>
        <h3>${user.display_name}</h3>
        <p>${user.bio || ""}</p>
      </div>
    </div>
  `;

  postsEl.innerHTML="";
  posts.forEach(p=>{
    const img=document.createElement("img");
    img.src = p.photo
      ? `${API_BASE}/media_proxy?file_id=${p.photo}`
      : "https://via.placeholder.com/300";
    postsEl.appendChild(img);
  });
}

safeStart(loadProfile);
