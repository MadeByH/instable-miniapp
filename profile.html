<script src="https://tapi.bale.ai/miniapp.js?3"></script>
<script src="auth.js"></script>

<script>
async function loadProfile(){
  const root = document.getElementById("profile-root");
  const postsEl = document.getElementById("profile-posts");
  const loading = document.getElementById("loading");

  loading.style.display = "block";

  const auth = await ensureRegistered();

  if (!auth.ok) {
    loading.style.display = "none";

    if (auth.reason === "NOT_REGISTERED") {
      location.replace("register.html");
      return;
    }

    root.innerHTML = `<p class="center-msg">عدم دسترسی</p>`;
    return;
  }

  const targetId =
    new URLSearchParams(location.search).get("user_id") || auth.userId;

  const userRes = await fetch(`${API_BASE}/get_user/${targetId}`);
  const postsRes = await fetch(`${API_BASE}/get_user_posts/${targetId}`);

  loading.style.display = "none";

  if (!userRes.ok) {
    root.innerHTML = `<p class="center-msg">کاربر یافت نشد</p>`;
    return;
  }

  const user = await userRes.json();
  const posts = await postsRes.json();

  root.innerHTML = `
    <div class="profile-head">
      <img class="avatar" src="${
        user.profile_pic
        ? `${API_BASE}/media_proxy?file_id=${user.profile_pic}`
        : 'https://via.placeholder.com/90'
      }">
      <div>
        <h3>${user.display_name}</h3>
        <p>${user.bio || ""}</p>
      </div>
    </div>
  `;

  postsEl.innerHTML = "";
  posts.forEach(p => {
    const img = document.createElement("img");
    img.src = p.photo
      ? `${API_BASE}/media_proxy?file_id=${p.photo}`
      : "https://via.placeholder.com/300";
    postsEl.appendChild(img);
  });
}

Bale.WebApp.ready();
loadProfile();
                </script>
